<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/global.css" />
  <title>Profile - Microblog Network</title>
    <!-- Run BEFORE page is finished loading (before window.onload): -->
    <script src="../account/auth.js"></script>
    <script>
      if (!isLoggedIn()) {
        window.location.replace("../account/login.html");
      }
    </script>
  <style>
     body {
    font-family: Arial, sans-serif;
    background-color: #1a1a1b;
    color: #d7dadc;
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden; /* Prevent horizontal overflow */
  }
  header {
    background-color: #272729;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  header h1 {
    color: #d7dadc;
    margin: 0;
  }
  nav {
    display: flex;
    align-items: center;
  }
  nav a {
    color: #d7dadc;
    margin-right: 15px;
    text-decoration: none;
    font-weight: bold;
  }
  nav a:hover {
    color: #fff;
  }

  .header-left, .header-right {
    display: flex;
    align-items: center;
  }
  .header-center {
    flex-grow: 1;
    display: flex;
    justify-content: center;
  }
  .search-bar {
    display: flex;
    align-items: center;
  }
  .search-bar input {
    padding: 8px;
    border: 1px solid #343536;
    border-radius: 4px;
    background-color: #1a1a1b;
    color: #d7dadc;
    margin-right: 10px;
  }
  .search-bar button {
    padding: 8px 16px;
    background-color: #d7dadc;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: #1a1a1b;
    font-weight: bold;
  }
  .search-bar button:hover {
    background-color: #818384;
  }
  main {
    display: flex;
    justify-content: center;
    padding: 20px;
    flex-grow: 1;
  }
  #profileContainer {
    background: #272729;
    border-radius: 8px;
    padding: 20px;
    max-width: 600px;
    width: 100%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    box-sizing: border-box; /* Ensure padding is included in width */
  }
  .profileHeader {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }
  .profileHeader img {
    border-radius: 50%;
    width: 80px;
    height: 80px;
    margin-right: 20px;
  }
  .profileHeader div {
    font-size: 20px;
    font-weight: bold;
  }
  .fullNameContainer {
    display: flex;
    flex-direction: column;
  }
  .username {
    font-size: 16px;
    color: #a3a3a3;
  }
  .profileInfo {
    display: flex;
    flex-direction: column;
  }
  .profileInfo div {
    margin-bottom: 10px;
  }
  .post {
    background: #1a1a1b;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
  }

   footer {
    background-color: #272729;
    color: #888;
    text-align: center;
    padding: 10px;
    border-top: 1px solid #343536;
    width: 100%;
    bottom: 0;
  }

  .sidebar {
    background: #272729;
    border-radius: 8px;
    padding: 20px;
    width: 250px; /* Adjusted width */
    margin-right: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .sidebar .avatar {
    background-color: #1a1a1b;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .sidebar .avatar img {
    border-radius: 50%;
    width: 60px;
    height: 60px;
  }
  .sidebar .usernameSidebarDisplay {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .sidebar .totalLikes, .sidebar .totalPosts {
    font-size: 14px;
    margin-bottom: 5px;
  }
  .sidebar .settings {
    margin-top: 20px;
    width: 100%;
  }
  .sidebar .settings button {
    background-color: #d7dadc; /* Updated to new color */
    border: none;
    color: #1a1a1b;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    margin-bottom: 10px;
  }
  .sidebar .settings button:last-child {
    margin-bottom: 0;
  }
  .form-input {
    margin-bottom: 10px;
    display: none;
  }
  .form-input input, .form-input textarea {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #343536;
    background-color: #1a1a1b;
    color: #d7dadc;
  }
  .form-input textarea {
    resize: none;
  }
  .confirm-button {
    display: none;
    background-color: #d7dadc;
    border: none;
    color: #1a1a1b;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
  }

  /* Updated text box styles */
  input[type="text"], textarea {
    font-size: 16px;
    line-height: 1.5;
    padding: 10px;
    margin-bottom: 10px;
    border: 2px solid #343536;
    border-radius: 8px;
    background-color: #1a1a1b;
    color: #d7dadc;
    transition: border-color 0.3s;
  }
  input[type="text"]:focus, textarea:focus {
    border-color: #d7dadc;
    outline: none;
  }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1><a href="../posts/posts.html" style="color: inherit; text-decoration: none;">Microblog Network</a></h1>
    </div>
    <div class="header-center">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search posts by username...">
        <button id="searchButton">Search</button>
      </div>
    </div>
    <div class="header-right">
      <nav>
        <a href="../posts/index.html">Home</a>
        <a href="../profile.html">Profile</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="sidebar" id="sidebar">
      <div class="avatar"><img src="https://via.placeholder.com/60" alt="Avatar" /></div>
      <div class="usernameSidebarDisplay">Test</div>
      <div class="totalLikes">Total Likes: <span id="totalLikesCount">0</span></div>
      <div class="totalPosts">Total Posts: <span id="totalPostsCount">0</span></div>
      <div class="settings">
        <button id="editProfileButton">Edit Profile</button>
        <button>Add Social Link</button>
        <button class="confirm-button" id="confirmButton">Confirm</button>
      </div>
    </div>
    <div id="profileContainer">
      <div class="profileHeader">
        <div class="fullNameContainer">
        </div>
      </div>
      <div class="profileInfo">
      </div>
    </div>
  </main>

 <footer>&copy; 2024 Microblog Network</footer>

  <script src="../account/auth.js"></script>
  <script>
    window.onload = function () {
      const loginData = getLoginData();
      const token = loginData.token;
      const apiBaseURL = "http://microbloglite.us-east-2.elasticbeanstalk.com/api";

      const profileContainer = document.querySelector("#profileContainer");
      const sidebar = document.querySelector("#sidebar");
      const totalLikesCount = document.querySelector("#totalLikesCount");
      const totalPostsCount = document.querySelector("#totalPostsCount");

      const editProfileButton = document.getElementById("editProfileButton");
      const confirmButton = document.getElementById("confirmButton");
      const searchButton = document.getElementById("searchButton");
      const searchInput = document.getElementById("searchInput");

      function loadingUserProfile() {
        fetch(`${apiBaseURL}/users/${loginData.username}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((user) => {
            // Profile Header
            const profileHeader = document.createElement("div");
            profileHeader.className = "profileHeader";

            const profilePic = document.createElement("img");
            profilePic.src = user.profilePicUrl || "https://via.placeholder.com/80"; // Replace with actual profile pic URL
            profileHeader.appendChild(profilePic);

            const fullNameContainer = document.createElement("div");
            fullNameContainer.className = "fullNameContainer";

            const profileName = document.createElement("div");
            profileName.className = "fullName";
            profileName.innerHTML = user.fullName;
            fullNameContainer.appendChild(profileName);

            const username = document.createElement("div");
            username.className = "username";
            username.innerHTML = `@${user.username}`;
            fullNameContainer.appendChild(username);

            profileHeader.appendChild(fullNameContainer);

            // Append header to profile container
            profileContainer.appendChild(profileHeader);

            // Profile Info
            const profileInfo = document.createElement("div");
            profileInfo.className = "profileInfo";

            const bioDiv = document.createElement("div");
            bioDiv.innerHTML = user.bio || "No bio available.";
            profileInfo.appendChild(bioDiv);

            profileContainer.appendChild(profileInfo);

            // Add editable fields
            const fullNameInput = document.createElement("input");
            fullNameInput.className = "form-input";
            fullNameInput.value = user.fullName;
            fullNameInput.id = "editFullName";
            profileContainer.appendChild(fullNameInput);

            const usernameInput = document.createElement("input");
            usernameInput.className = "form-input";
            usernameInput.value = user.username;
            usernameInput.id = "editUsername";
            profileContainer.appendChild(usernameInput);

            const bioTextarea = document.createElement("textarea");
            bioTextarea.className = "form-input";
            bioTextarea.value = user.bio || "";
            bioTextarea.id = "editBio";
            profileContainer.appendChild(bioTextarea);

            editProfileButton.addEventListener("click", () => {
              fullNameInput.style.display = "block";
              usernameInput.style.display = "block";
              bioTextarea.style.display = "block";
              confirmButton.style.display = "block";
            });

            confirmButton.addEventListener("click", () => {
              const updatedFullName = document.getElementById("editFullName").value;
              const updatedUsername = document.getElementById("editUsername").value;
              const updatedBio = document.getElementById("editBio").value;

              const updatedData = {
                fullName: updatedFullName,
                username: updatedUsername,
                bio: updatedBio,
              };

              fetch(`${apiBaseURL}/users/${loginData.username}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(updatedData),
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Network response was not ok");
                  }
                  return response.json();
                })
                .then((updatedUser) => {
                  profileName.innerHTML = updatedUser.fullName;
                  username.innerHTML = `@${updatedUser.username}`;
                  bioDiv.innerHTML = updatedUser.bio;

                  fullNameInput.style.display = "none";
                  usernameInput.style.display = "none";
                  bioTextarea.style.display = "none";
                  confirmButton.style.display = "none";
                })
                .catch((error) => {
                  console.error("Error updating profile:", error);
                });
            });
          })
          .catch((error) => {
            console.error("Error fetching user data:", error);
            profileContainer.innerHTML = "<p>Error loading profile data.</p>";
          });
      }

      function searchPostsByUsername(username) {
        fetch(`${apiBaseURL}/posts?username=${username}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((posts) => {
            // Clear existing posts
            profileContainer.innerHTML = "";
            if (posts.length === 0) {
              profileContainer.innerHTML = "<p>No posts found.</p>";
              return;
            }
            posts.forEach((post) => {
              const postDiv = document.createElement("div");
              postDiv.className = "post";

              const postHeader = document.createElement("div");
              postHeader.className = "post-header";
              postHeader.innerHTML = `<strong>@${post.username}</strong> <span>${new Date(post.createdAt).toLocaleString()}</span>`;
              postDiv.appendChild(postHeader);

              const postContent = document.createElement("div");
              postContent.className = "post-content";
              postContent.innerHTML = post.text;
              postDiv.appendChild(postContent);

              profileContainer.appendChild(postDiv);
            });
          })
          .catch((error) => {
            console.error("Error fetching posts:", error);
            profileContainer.innerHTML = "<p>Error loading posts.</p>";
          });
      }

      searchButton.addEventListener("click", () => {
        const username = searchInput.value.trim();
        if (username) {
          searchPostsByUsername(username);
        }
      });

      function getUserTotalLikes() {
        fetch(`${apiBaseURL}/users/${loginData.username}/likes`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((likes) => {
            totalLikesCount.innerText = likes.length;
          })
          .catch((error) => {
            console.error("Error fetching user likes:", error);
            totalLikesCount.innerText = "Error";
          });
      }

      function getUserTotalPosts() {
        fetch(`${apiBaseURL}/users/${loginData.username}/posts`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((posts) => {
            totalPostsCount.innerText = posts.length;
          })
          .catch((error) => {
            console.error("Error fetching user posts:", error);
            totalPostsCount.innerText = "Error";
          });
      }

      function getLoginData() {
        const loginJSON = window.localStorage.getItem("login-data");
        return JSON.parse(loginJSON) || {};
      }

      loadingUserProfile();
      getUserTotalLikes();
      getUserTotalPosts();
    };
  </script>
</body>
</html>
